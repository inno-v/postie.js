// Generated by CoffeeScript 1.4.0
/*
Postie.js
Copyright 2013 Paul Springett

Version: 0.1.0
Author: Paul Springett
URL: http://github.com/paulspringett/postie.js

Released under the MIT license
http://mit-license.org/
*/((function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b=[].slice;window.Postie={},Postie.Client=function(){function c(b){this._receive=a(this._receive,this),this._listen(),this.serverUrl=b}return c.prototype._callbacks=[],c.prototype.ready=function(a){var b=this;return this._createFrame(this.serverUrl,function(){var c;return c=b._dispatch("getEndpoints",!0),b._registerCallback(c,function(c){return b._createEndpoints(c),a()})})},c.prototype._registerCallback=function(a,b){return this._callbacks.push({uuid:a,fn:b}),[a,b]},c.prototype._createFrame=function(a,b){var c;return c=document.createElement("iframe"),c.setAttribute("src",a),c.setAttribute("id","postie-server-iframe"),c.setAttribute("style","display:none;"),c.onload=b,document.body.appendChild(c),this._frame=c.contentWindow},c.prototype._createEndpoints=function(a){var c,d,e,f,g=this;this._endpoints=a,d=function(a){return g[a]=function(){var c,d,e,f,g;c=1<=arguments.length?b.call(arguments,0):[],g=this._parseArgs(c),e=g[0],d=g[1],f=this._dispatch(a,e);if(d!=null)return this._registerCallback(f,d)}};for(e=0,f=a.length;e<f;e++)c=a[e],d(c);return this},c.prototype._parseArgs=function(a){var b;if(a.length>2)throw new Error("ArgumentError: more than 2 args passed to an endpoint. Pass a data argument and a callback argument only");return a.length===2?a:a.length===1?(b=a[0],typeof b=="function"?[null,b]:[b,null]):[null,null]},c.prototype._dispatch=function(a,b){var c,d;return d=this._generateUuid(),c=this._payload(d,a,b),this._frame.postMessage(c,"*"),d},c.prototype._payload=function(a,b,c){var d;return d={uuid:a,method:b,payload:c},JSON.stringify(d)},c.prototype._generateUuid=function(){var a;return a=function(){return((1+Math.random())*65536|0).toString(16).substring(1)},""+a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},c.prototype._listen=function(){if(window.addEventListener!=null)return window.addEventListener("message",this._receive,!1);if(window.attachEvent!=null)return window.attachEvent("onmessage",this._receive);throw new Error('cannot bind to postMessage "message" event on window')},c.prototype._receive=function(a){var b,c;c=new Postie.Event(a),b=_.find(this._callbacks,function(a){return a.uuid===c.uuid});if(b==null)return;return b.fn(c.data),this._callbacks=_.without(this._callbacks,b)},c}(),Postie.Event=function(){function a(a){var b;try{b=JSON.parse(a.data)}catch(c){throw new Error("Failed to parse JSON "+a.data+", with error: "+c)}this.uuid=b.uuid,this.method=b.method,this.data=b.payload,this.source=a.source}return a.prototype.success=!1,a}(),Postie.Server=function(){function b(b){b==null&&(b={}),this.receive=a(this.receive,this),this.receiver=b.receiver,this._listEndpoints(this.receiver)}return b.prototype.endpoints=[],b.prototype.receive=function(a){var b,c,d=this;return b=new Postie.Event(a),b.method==="getEndpoints"?this.dispatch(b,this.endpoints):(c=function(a){return d.dispatch(b,a)},this.receiver[b.method](b.data,c))},b.prototype.dispatch=function(a,b){var c,d;return c=a.source,d=this.payload(a.uuid,b),c.postMessage(d,"*"),a.uuid},b.prototype.payload=function(a,b){var c;return c={uuid:a,payload:b},JSON.stringify(c)},b.prototype.listen=function(){if(window.addEventListener!=null)return window.addEventListener("message",this.receive,!1);if(window.attachEvent!=null)return window.attachEvent("onmessage",this.receive);throw new Error('cannot bind to postMessage "message" event on window')},b.prototype._listEndpoints=function(a){var b,c;for(c in a)b=a[c],this.endpoints.push(c);return this.endpoints},b}()})).call(this);