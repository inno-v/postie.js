// Generated by CoffeeScript 1.3.3
/*
Postie.js
Copyright 2013 Paul Springett

Version: 0.1.0
Author: Paul Springett
URL: http://github.com/paulspringett/postie.js

Released under the MIT license
http://mit-license.org/
*/(function(){var e,t,n=function(e,t){return function(){return e.apply(t,arguments)}},r=[].slice;e={},e.Client=function(){function t(e){this._receive=n(this._receive,this),this._listen(),this.serverUrl=e}return t.prototype._callbacks=[],t.prototype.ready=function(e){var t=this;return this._createFrame(this.serverUrl,function(){var n;return n=t._dispatch("getEndpoints",!0),t._registerCallback(n,function(n){return t._createEndpoints(n),e()})})},t.prototype._registerCallback=function(e,t){return this._callbacks.push({uuid:e,fn:t}),[e,t]},t.prototype._createFrame=function(e,t){var n;return n=document.createElement("iframe"),n.setAttribute("src",e),n.setAttribute("id","postie-server-iframe"),n.setAttribute("style","display:none;"),n.onload=t,document.body.appendChild(n),this._frame=n.contentWindow},t.prototype._createEndpoints=function(e){var t,n,i,s,o=this;this._endpoints=e,n=function(e){return o[e]=function(){var t,n,i,s,o;t=1<=arguments.length?r.call(arguments,0):[],o=this._parseArgs(t),i=o[0],n=o[1],s=this._dispatch(e,i);if(n!=null)return this._registerCallback(s,n)}};for(i=0,s=e.length;i<s;i++)t=e[i],n(t);return this},t.prototype._parseArgs=function(e){var t;if(e.length>2)throw new Error("ArgumentError: more than 2 args passed to an endpoint. Pass a data argument and a callback argument only");return e.length===2?e:e.length===1?(t=e[0],typeof t=="function"?[null,t]:[t,null]):[null,null]},t.prototype._dispatch=function(e,t){var n,r;return r=this._generateUuid(),n=this._payload(r,e,t),this._frame.postMessage(n,"*"),r},t.prototype._payload=function(e,t,n){var r;return r={postie:!0,uuid:e,method:t,payload:n},JSON.stringify(r)},t.prototype._generateUuid=function(){var e;return e=function(){return((1+Math.random())*65536|0).toString(16).substring(1)},""+e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},t.prototype._listen=function(){if(window.addEventListener!=null)return window.addEventListener("message",this._receive,!1);if(window.attachEvent!=null)return window.attachEvent("onmessage",this._receive);throw new Error('cannot bind to postMessage "message" event on window')},t.prototype._receive=function(t){var n,r;r=new e.Event(t);if(!r.isValid)return;n=_.find(this._callbacks,function(e){return e.uuid===r.uuid});if(n==null)return;return n.fn(r.data),this._callbacks=_.without(this._callbacks,n)},t}(),t=typeof exports!="undefined"&&exports!==null?exports:this,t.Postie=e,e.Event=function(){function e(e){var t;try{t=JSON.parse(e.data),t.postie&&(this.isValid=!0),this.uuid=t.uuid,this.method=t.method,this.data=t.payload,this.source=e.source}catch(n){console.log("Failed to parse JSON "+e.data+", with error: "+n),this.isValid=!1}}return e.prototype.success=!1,e.prototype.isValid=!1,e}(),e.Server=function(){function t(e){e==null&&(e={}),this.receive=n(this.receive,this),this.receiver=e.receiver,this._listEndpoints(this.receiver)}return t.prototype.endpoints=[],t.prototype.receive=function(t){var n,r,i=this;n=new e.Event(t);if(!n.isValid)return;return n.method==="getEndpoints"?this.dispatch(n,this.endpoints):(r=function(e){return i.dispatch(n,e)},this.receiver[n.method](n.data,r))},t.prototype.dispatch=function(e,t){var n,r;return n=e.source,r=this.payload(e.uuid,t),n.postMessage(r,"*"),e.uuid},t.prototype.payload=function(e,t){var n;return n={postie:!0,uuid:e,payload:t},JSON.stringify(n)},t.prototype.listen=function(){if(window.addEventListener!=null)return window.addEventListener("message",this.receive,!1);if(window.attachEvent!=null)return window.attachEvent("onmessage",this.receive);throw new Error('cannot bind to postMessage "message" event on window')},t.prototype._listEndpoints=function(e){var t,n;for(n in e)t=e[n],this.endpoints.push(n);return this.endpoints},t}()}).call(this);