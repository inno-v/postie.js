// Generated by CoffeeScript 1.4.0
/*
Postie.js
Copyright 2013 Paul Springett

Version: 0.1.0
Author: Paul Springett
URL: http://github.com/paulspringett/postie.js

Released under the MIT license
http://mit-license.org/
*/((function(){var a,b,c=function(a,b){return function(){return a.apply(b,arguments)}},d=[].slice;a={},a.Client=function(){function e(a){this._receive=c(this._receive,this),this._listen(),this.serverUrl=a}return e.prototype._callbacks=[],e.prototype.ready=function(a){var b=this;return this._createFrame(this.serverUrl,function(){var c;return c=b._dispatch("getEndpoints",!0),b._registerCallback(c,function(c){return b._createEndpoints(c),a()})})},e.prototype._registerCallback=function(a,b){return this._callbacks.push({uuid:a,fn:b}),[a,b]},e.prototype._createFrame=function(a,b){var c;return c=document.createElement("iframe"),c.setAttribute("src",a),c.setAttribute("id","postie-server-iframe"),c.setAttribute("style","display:none;"),c.onload=b,document.body.appendChild(c),this._frame=c.contentWindow},e.prototype._createEndpoints=function(a){var b,c,e,f,g=this;this._endpoints=a,c=function(a){return g[a]=function(){var b,c,e,f,g;b=1<=arguments.length?d.call(arguments,0):[],g=this._parseArgs(b),e=g[0],c=g[1],f=this._dispatch(a,e);if(c!=null)return this._registerCallback(f,c)}};for(e=0,f=a.length;e<f;e++)b=a[e],c(b);return this},e.prototype._parseArgs=function(a){var b;if(a.length>2)throw new Error("ArgumentError: more than 2 args passed to an endpoint. Pass a data argument and a callback argument only");return a.length===2?a:a.length===1?(b=a[0],typeof b=="function"?[null,b]:[b,null]):[null,null]},e.prototype._dispatch=function(a,b){var c,d;return d=this._generateUuid(),c=this._payload(d,a,b),this._frame.postMessage(c,"*"),d},e.prototype._payload=function(a,b,c){var d;return d={uuid:a,method:b,payload:c},JSON.stringify(d)},e.prototype._generateUuid=function(){var a;return a=function(){return((1+Math.random())*65536|0).toString(16).substring(1)},""+a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},e.prototype._listen=function(){if(b.addEventListener!=null)return b.addEventListener("message",this._receive,!1);if(b.attachEvent!=null)return b.attachEvent("onmessage",this._receive);throw new Error('cannot bind to postMessage "message" event on window')},e.prototype._receive=function(b){var c,d;d=new a.Event(b),c=_.find(this._callbacks,function(a){return a.uuid===d.uuid});if(c==null)return;return c.fn(d.data),this._callbacks=_.without(this._callbacks,c)},e}(),b=typeof exports!="undefined"&&exports!==null?exports:this,b.Postie=a,a.Event=function(){function a(a){var b;try{b=JSON.parse(a.data)}catch(c){throw new Error("Failed to parse JSON "+a.data+", with error: "+c)}this.uuid=b.uuid,this.method=b.method,this.data=b.payload,this.source=a.source}return a.prototype.success=!1,a}(),a.Server=function(){function b(a){a==null&&(a={}),this.receive=c(this.receive,this),this.receiver=a.receiver,this._listEndpoints(this.receiver)}return b.prototype.endpoints=[],b.prototype.receive=function(b){var c,d,e=this;return c=new a.Event(b),c.method==="getEndpoints"?this.dispatch(c,this.endpoints):(d=function(a){return e.dispatch(c,a)},this.receiver[c.method](c.data,d))},b.prototype.dispatch=function(a,b){var c,d;return c=a.source,d=this.payload(a.uuid,b),c.postMessage(d,"*"),a.uuid},b.prototype.payload=function(a,b){var c;return c={uuid:a,payload:b},JSON.stringify(c)},b.prototype.listen=function(){if(window.addEventListener!=null)return window.addEventListener("message",this.receive,!1);if(window.attachEvent!=null)return window.attachEvent("onmessage",this.receive);throw new Error('cannot bind to postMessage "message" event on window')},b.prototype._listEndpoints=function(a){var b,c;for(c in a)b=a[c],this.endpoints.push(c);return this.endpoints},b}()})).call(this);