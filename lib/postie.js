// Generated by CoffeeScript 1.3.3
(function() {
  var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __slice = [].slice;

  window.Postie = {};

  Postie.Client = (function() {

    Client.prototype._callbacks = [];

    function Client(options) {
      if (options == null) {
        options = {};
      }
      this._receive = __bind(this._receive, this);

      this._listen();
      this._frame = this._parseFrame(options.server);
      this._endpoints = options.methods;
    }

    Client.prototype.ready = function(callback) {
      var _this = this;
      console.log("Ready!", callback);
      return setTimeout(function() {
        var uuid;
        uuid = _this._dispatch('_getEndpoints', true);
        return _this._registerCallback(uuid, function(methods) {
          console.log("callback", methods);
          _this._createEndpoints(methods);
          return callback();
        });
      }, 100);
    };

    Client.prototype._createEndpoints = function(endpoints) {
      var endpoint, _i, _len;
      console.log("creating endpoints", endpoints);
      for (_i = 0, _len = endpoints.length; _i < _len; _i++) {
        endpoint = endpoints[_i];
        this[endpoint] = function() {
          var args, callback, data, uuid, _ref;
          args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
          _ref = this._parseArgs(args), data = _ref[0], callback = _ref[1];
          uuid = this._dispatch(endpoint, data);
          if (callback != null) {
            return this._registerCallback(uuid, callback);
          }
        };
      }
      return true;
    };

    Client.prototype._registerCallback = function(uuid, fn) {
      this._callbacks.push({
        uuid: uuid,
        fn: fn
      });
      console.log("registered callback", this._callbacks);
      return [uuid, fn];
    };

    Client.prototype._parseFrame = function(frame) {
      if (typeof frame === 'string') {
        frame = document.getElementById(frame);
      }
      if (typeof frame.contentWindow === 'object') {
        frame = frame.contentWindow;
      }
      try {
        if (typeof frame.postMessage === 'function') {
          return frame;
        }
      } catch (err) {
        throw new Error("Could not establish postMessage API for frame: " + frame + ", must be an iframe");
      }
    };

    Client.prototype._payload = function(uuid, method, data) {
      var message;
      try {
        message = {
          uuid: uuid,
          method: method,
          payload: data
        };
        return JSON.stringify(message);
      } catch (err) {
        return console.log("Could not stringify data: " + this.data + " with " + err);
      }
    };

    Client.prototype._parseArgs = function(args) {
      var arg;
      if (args.length > 2) {
        throw new Error('ArgumentError: more than 2 args passed to an endpoint. Pass a data argument and a callback argument only');
      }
      if (args.length === 2) {
        return args;
      }
      if (args.length === 1) {
        arg = args[0];
        if (typeof arg === 'function') {
          return [null, arg];
        } else {
          return [arg, null];
        }
      }
      return [null, null];
    };

    Client.prototype._dispatch = function(method, data) {
      var payload, uuid;
      uuid = this._generateUuid();
      payload = this._payload(uuid, method, data);
      console.log("_dispatch payload", payload);
      this._frame.postMessage(payload, '*');
      return uuid;
    };

    Client.prototype._generateUuid = function() {
      var s4;
      s4 = function() {
        return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
      };
      return "" + (s4()) + (s4()) + "-" + (s4()) + "-" + (s4()) + "-" + (s4()) + "-" + (s4()) + (s4()) + (s4());
    };

    Client.prototype._listen = function() {
      if (window.addEventListener != null) {
        return window.addEventListener('message', this._receive, false);
      } else if (window.attachEvent != null) {
        return window.attachEvent('onmessage', this._receive);
      } else {
        throw new Error('cannot bind to postMessage "message" event on window');
      }
    };

    Client.prototype._receive = function(rawEvent) {
      var callback, event;
      event = new Postie.Event(rawEvent);
      callback = _.find(this._callbacks, function(cb) {
        return cb.uuid === event.uuid;
      });
      if (callback == null) {
        return;
      }
      callback.fn(event.data);
      return this._callbacks = _.without(this._callbacks, callback);
    };

    return Client;

  })();

  Postie.Event = (function() {

    Event.prototype.success = false;

    function Event(event) {
      var message;
      if (!event) {
        throw "Cannot construct a PostieEvent with a postMessage event object";
      }
      message = JSON.parse(event.data);
      this.uuid = message.uuid;
      this.method = message.method;
      this.data = message.payload;
      this.source = event.source;
    }

    return Event;

  })();

  Postie.Server = (function() {

    Server.prototype.endpoints = [];

    function Server(options) {
      if (options == null) {
        options = {};
      }
      this.receive = __bind(this.receive, this);

      this.receiver = options.receiver;
      this.listen();
      console.log("@receiver", this.receiver);
    }

    Server.prototype.receive = function(rawEvent) {
      var event, responseData;
      event = new Postie.Event(rawEvent);
      if (event.method === '_getEndpoints') {
        console.log('_getEndpoints');
        this.endpoints = this.listEndpoints(this.receiver);
        this.dispatch(event, this.endpoints);
      } else {
        responseData = this.receiver[event.method](event.data);
      }
      return this.dispatch(event, responseData);
    };

    Server.prototype.dispatch = function(event, responseData) {
      var frame, payload;
      frame = event.source;
      payload = this.payload(event.uuid, responseData);
      frame.postMessage(payload, '*');
      return event.uuid;
    };

    Server.prototype.payload = function(uuid, data) {
      var message;
      try {
        message = {
          uuid: uuid,
          payload: data
        };
        return JSON.stringify(message);
      } catch (err) {
        return console.log("Could not stringify data: " + data + " with " + err);
      }
    };

    Server.prototype.listen = function() {
      if (window.addEventListener != null) {
        return window.addEventListener('message', this.receive, false);
      } else if (window.attachEvent != null) {
        return window.attachEvent('onmessage', this.receive);
      } else {
        throw new Error('cannot bind to postMessage "message" event on window');
      }
    };

    Server.prototype.listEndpoints = function(receiver) {
      var fn, method;
      for (method in receiver) {
        fn = receiver[method];
        this.endpoints.push(method);
      }
      console.log("listEndpoints", this.endpoints);
      return this.endpoints;
    };

    return Server;

  })();

}).call(this);
